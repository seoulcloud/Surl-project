AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "Surl - AI \uD2B8\uB80C\uB4DC \uB9AC\uD3EC\uD2B8 \uAC00\uC2DC\uC131\uC774\
  \ \uAC1C\uC120\uB41C \uBAA8\uB2C8\uD130\uB9C1 \uB300\uC2DC\uBCF4\uB4DC"
Globals:
  Function:
    Runtime: python3.12
    Timeout: 20
    MemorySize: 256
Resources:
  SurlCounterTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName: SurlCounter
      PrimaryKey:
        Name: counter_name
        Type: String
  SurlMappingTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: shortCode
        Type: String
  SurlClickLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: shortCode
        AttributeType: S
      - AttributeName: timestamp
        AttributeType: S
      KeySchema:
      - AttributeName: shortCode
        KeyType: HASH
      - AttributeName: timestamp
        KeyType: RANGE
  CreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateFunction
      Handler: create.app.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: SurlMappingTable
          COUNTER_TABLE_NAME:
            Ref: SurlCounterTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SurlMappingTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SurlCounterTable
      - Statement:
        - Effect: Allow
          Action: bedrock:InvokeModel
          Resource: arn:aws:bedrock:ap-northeast-2::foundation-model/anthropic.claude-3-haiku-20240307-v1:0
      Events:
        CreateApi:
          Type: Api
          Properties:
            Path: /create
            Method: post
    Metadata:
      SamResourceId: CreateFunction
  RedirectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RedirectFunction
      Handler: redirect.app.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: SurlMappingTable
          LOG_TABLE_NAME:
            Ref: SurlClickLogsTable
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: SurlMappingTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SurlClickLogsTable
      - Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
      Events:
        RedirectApi:
          Type: Api
          Properties:
            Path: /{shortCode}
            Method: get
    Metadata:
      SamResourceId: RedirectFunction
  TrendFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TrendFunction
      Handler: trend.app.handler
      Environment:
        Variables:
          LOG_TABLE_NAME:
            Ref: SurlClickLogsTable
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: SurlClickLogsTable
      - Statement:
        - Effect: Allow
          Action: bedrock:InvokeModel
          Resource: arn:aws:bedrock:ap-northeast-2::foundation-model/anthropic.claude-3-haiku-20240307-v1:0
      Events:
        TrendApi:
          Type: Api
          Properties:
            Path: /trend
            Method: get
    Metadata:
      SamResourceId: TrendFunction
  SurlOperationDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: Surl-Advanced-Operation-Dashboard
      DashboardBody:
        Fn::Sub: "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\", \"x\": 0,\
          \ \"y\": 0, \"width\": 12, \"height\": 6,\n      \"properties\": {\n   \
          \     \"title\": \"Traffic Overview\",\n        \"metrics\": [\n       \
          \   [ \"AWS/Lambda\", \"Invocations\", \"FunctionName\", \"${CreateFunction}\"\
          , { \"label\": \"Create\" } ],\n          [ \"...\", \"Invocations\", \"\
          FunctionName\", \"${RedirectFunction}\", { \"label\": \"Redirect\" } ],\n\
          \          [ \"...\", \"Invocations\", \"FunctionName\", \"${TrendFunction}\"\
          , { \"label\": \"Trend\" } ]\n        ],\n        \"view\": \"timeSeries\"\
          , \"region\": \"${AWS::Region}\"\n      }\n    },\n    {\n      \"type\"\
          : \"metric\", \"x\": 12, \"y\": 0, \"width\": 12, \"height\": 6,\n     \
          \ \"properties\": {\n        \"title\": \"Performance: Latency\",\n    \
          \    \"metrics\": [\n          [ \"AWS/Lambda\", \"Duration\", \"FunctionName\"\
          , \"${CreateFunction}\", { \"stat\": \"p90\" } ],\n          [ \"...\",\
          \ \"Duration\", \"FunctionName\", \"${RedirectFunction}\", { \"stat\": \"\
          p90\" } ],\n          [ \"...\", \"Duration\", \"FunctionName\", \"${TrendFunction}\"\
          , { \"stat\": \"p90\" } ]\n        ],\n        \"view\": \"timeSeries\"\
          , \"region\": \"${AWS::Region}\"\n      }\n    },\n    {\n      \"type\"\
          : \"log\", \"x\": 0, \"y\": 6, \"width\": 24, \"height\": 8,\n      \"properties\"\
          : {\n        \"title\": \"AI Trend Analysis Report (AI \uD2B8\uB80C\uB4DC\
          \ \uBD84\uC11D \uB9AC\uD3EC\uD2B8)\",\n        \"region\": \"${AWS::Region}\"\
          ,\n        \"query\": \"SOURCE '/aws/lambda/${TrendFunction}' | filter @message\
          \ like /REPORT_DATA:/ | parse @message \\\"REPORT_DATA: [*] * [*] * [*]\
          \ *\\\" as fieldTag, popular, reasonTag, reason, summaryTag, summary | display\
          \ @timestamp, popular as `\uC778\uAE30\uBD84\uC57C`, reason as `\uD074\uB9AD\
          \uC0AC\uC720`, summary as `\uD55C\uC904\uC694\uC57D` | sort @timestamp desc\
          \ | limit 5\",\n        \"view\": \"table\"\n      }\n    }\n  ]\n}\n"
  CreateLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${CreateFunction}
      RetentionInDays: 7
  RedirectLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${RedirectFunction}
      RetentionInDays: 7
  TrendLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${TrendFunction}
      RetentionInDays: 7
Outputs:
  ApiEndpoint:
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
